---
title: "project"
output: html_document
date: "2025-05-01"
---

```{r}
library(tidyverse)
library(ggplot2)
library(corrplot)
library(car)
library(caret)
library(knitr)
library(kableExtra)
```

Data Loading and Exploration
```{r}
# Load the dataset
car_data <- read.csv("BMGT430/car_price_prediction.csv")

# Check if first row contains column names and remove if needed
if(car_data[1,1] == "ID") {
  car_data <- car_data[-1,]
}

# Display dataset dimensions
dim(car_data)

# Display the first few rows
head(car_data)

# Check the structure
str(car_data)
```

Exploratory Data Analysis
Distribution of Car Prices
```{r}
# Histogram of car prices
ggplot(car_data_clean, aes(x = Price)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black") +
  labs(title = "Distribution of Car Prices", x = "Price", y = "Frequency") +
  theme_minimal()

# Log transformation of prices to handle skewness
ggplot(car_data_clean, aes(x = log(Price))) +
  geom_histogram(bins = 30, fill = "steelblue", color = "black") +
  labs(title = "Distribution of Log-Transformed Car Prices", x = "Log(Price)", y = "Frequency") +
  theme_minimal()

```
Data Cleaning and Preparation
```{r}
# Convert character columns to appropriate types
car_data$Price <- as.numeric(car_data$Price)
car_data$Levy <- as.numeric(ifelse(car_data$Levy == "-", NA, car_data$Levy))
car_data$Prod..year <- as.numeric(car_data$Prod..year)

# Clean Engine volume (remove "Turbo" from strings and convert to numeric)
car_data$Engine.volume <- as.numeric(gsub(" Turbo", "", car_data$Engine.volume))

# Clean Mileage (remove "km" and convert to numeric)
car_data$Mileage <- as.numeric(gsub(" km", "", car_data$Mileage))

car_data$Cylinders <- as.numeric(car_data$Cylinders)
car_data$Airbags <- as.numeric(car_data$Airbags)

# Remove rows with missing values or impute them
car_data_clean <- na.omit(car_data)

# Select numerical variables for outlier detection
numerical_vars <- c("Price", "Levy", "Prod..year", "Engine.volume", "Mileage", "Cylinders", "Airbags")

# Function to remove outliers using IQR method
remove_outliers <- function(data, vars) {
  for (var in vars) {
    qnt <- quantile(data[[var]], probs = c(0.25, 0.75), na.rm = TRUE)
    iqr <- qnt[2] - qnt[1]
    lower <- qnt[1] - 1.5 * iqr
    upper <- qnt[2] + 1.5 * iqr
    data <- data[data[[var]] >= lower & data[[var]] <= upper, ]
  }
  return(data)
}

# Remove outliers
car_data_clean <- remove_outliers(car_data_clean, numerical_vars)

car_data_clean$Age <- 2025 - car_data_clean$Prod..year

# Check dimensions after outlier removal
dim(car_data_clean)
```
Further Cleaning and Preparation
```{r}
#Converting Mileage units from km to mi
car_data_clean$Mileage <- car_data_clean$Mileage * 0.621371
#Rounding to the nearest 2nd number
car_data_clean$Mileage <- round(car_data_clean$Mileage, 2)

#Keeping entries where car price is greater than or equal to 10,000
car_data_clean <- car_data_clean[car_data_clean$Price >= 10000, ]

attach(car_data_clean)
```

```{r}
base <- lm(Price ~ Age + Mileage + Engine.volume + factor(Manufacturer) + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(base)
plot(base)
```

```{r}
model <- lm(log(Price) ~ Age + Mileage + Engine.volume + factor(Manufacturer) + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(model)
plot(model)
```

We thought that different car brands might hold their value differently as they become older so we added the interation term Manufacturer*Age
```{r}
model2<-lm(log(Price) ~ Age + Mileage + Engine.volume + factor(Manufacturer) + Manufacturer:Age + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(model2)
plot(model2)
```
Maybe there is a relationship between different Manufacturers and the mileage
```{r}
model3<-lm(log(Price) ~ Age + Mileage + Engine.volume + factor(Manufacturer) + Manufacturer:Age + Manufacturer:Mileage + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(model3)
plot(model3)
```

We thought that the Mileage and Price might have a quadratic relationship rather than a linear on.
```{r}
model4<-lm(log(Price) ~ Age + I(Mileage-68735.42) + I((Mileage-68735.42)^2) + Engine.volume + factor(Manufacturer) + Manufacturer:Age + Manufacturer:Mileage + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(model4)
plot(model4)
```
We then tried the same thing for Age
```{r}
model5<-lm(log(Price) ~ I(Age-11.50747) + I((Age-11.50747)^2) + I(Mileage-68735.42) + I((Mileage-68735.42)^2) + Engine.volume + factor(Manufacturer) + Manufacturer:Age + Manufacturer:Mileage + factor(Category) + factor(Leather.interior) + factor(Fuel.type) + factor(Gear.box.type) + factor(Drive.wheels) + factor(Wheel) + factor(Color) + Airbags, data = car_data_clean)
summary(model5)
plot(model5)
```